{{- range $path, $_ := .Files.Glob "applications/*/Chart.yaml" }}
{{- $app := $.Files.Get $path | fromYaml }}
{{- range $env_name, $env := $.Values.envs }}
{{- if $env.isEphemeral }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: {{ $env_name }}-{{ $app.name }}
  namespace: {{ $.Values.kargo.projectName }}
spec:
  requestedFreight:
  - origin:
      kind: Warehouse
      name: {{ $app.name }}
    sources:
      {{ $env.sources | toYaml }}
  promotionTemplate:
    spec:
      vars:
      - name: gitRepo
        value: {{ $.Values.repo.repoURL }}
      - name: targetBranch
        value: {{ $env.targetBranchPrefix }}/{{ $app.name }}
      - name: path_src
        value: ./src
      - name: path_out
        value: ./out
      steps:
      # TODO
      # We want to test an update from old to new and since this is an ephemeral environment we need to first deploy the old version
      # Open a PR with the original deployment manifests and let the ArgoCD PR generator handle the ephemeral deployment
      # - task:
      #     name: prepare-workdir 
      #   vars:
      #   - name: clearPath
      #     value: "false"
      # - task:
      #     name: push-manifests
      #   as: promotion-orig
      #   vars:
      #   - name: asPR
      #     value: "true"
      #   - name: targetBranch
      #     value: {{ $env.targetBranchPrefix }}/{{ $app.name }}
      # - uses: argocd-update
      #   config:
      #     apps:
      #     - name: {{ $env_name }}-{{ $app.name }}
      #       sources:
      #       - repoURL: {{`${{ vars.gitRepo }}`}}
      #         desiredRevision: {{`${{ outputs.promotion-orig.commit }}`}}
      - task:
          name: prepare-workdir 
      # The config-generator chart needs access to the config manifests
      # Copy config manifests into config-generator chart
      - uses: copy
        config:
          inPath: "{{`${{ vars.path_src }}`}}/config"
          outPath: "{{`${{ vars.path_src }}`}}/charts/config-generator/config/platform"
      - uses: copy
        config:
          inPath: "{{`${{ vars.path_src }}`}}/{{ dir $path }}/config"
          outPath: "{{`${{ vars.path_src }}`}}/charts/config-generator/config/application"
      # Render the config files from templates
      - uses: helm-template
        config:
          releaseName: config-generator
          path: "{{`${{ vars.path_src }}`}}/charts/config-generator"
          outLayout: flat
          outPath: /tmp/values.yaml
          setValues:
            - key: envName
              value: {{ $env_name }}
            - key: envType
              value: {{ $env.envType }}
            - key: appName
              value: {{ $app.name }}
          #valuesFiles:
          #- {{`${{ vars.path_src }}`}}/config/{{ $env_name }}/{{ $app.name }}-values.yaml
          #- {{`${{ vars.path_src }}`}}/{{ dir $path }}/values/{{ $env_name }}.yaml
      - uses: helm-template
        config:
          releaseName: "{{ $env_name }}-{{ $app.releaseName | default $app.name }}"
          namespace: "{{ $env_name }}-{{ $app.namespace | default $app.name }}"
          buildDependencies: true
          includeCRDs: true
          path: "{{`${{ vars.path_src }}`}}/{{ dir $path }}"
          outPath: "{{`${{ vars.path_out }}`}}/deploy/{{ $app.name }}"
          valuesFiles:
          - /tmp/values.yaml
      - task:
          name: push-manifests
        as: promotion
        vars:
        - name: asPR
          value: "{{ $env.asPR }}"
        - name: waitForPR
          value: "false"
        - name: targetBranch
          value: "{{ $env.targetBranchPrefix }}/{{ $app.name }}"
      # Verify the ephemeral deployment via ArgoCD
      # Increased retry threshold and added timeout to handle:
      #   1. ApplicationSet polling delay (up to 60s for PR detection)
      #   2. Slow image pulls or initialization on first deploy
      - uses: argocd-update
        if: {{`${{ outputs.promotion.prNumber != "" }}`}}
        retry:
          errorThreshold: 10
          timeout: 10m0s
        config:
          apps:
          - name: "pr-{{`${{ outputs.promotion.prNumber }}`}}-{{ $env_name }}-{{ $app.name }}"
            sources:
            - repoURL: "{{`${{ vars.gitRepo }}`}}"
              desiredRevision: "{{`${{ outputs.promotion.commit }}`}}"
      # Auto-merge the PR after successful verification
      # This eliminates the race condition where manually closing the PR
      # causes ArgoCD to delete the Application before Kargo finishes verification.
      # The PR is only merged AFTER argocd-update confirms the app is synced and healthy.
      - uses: git-merge-pr
        as: merge-pr
        if: {{`${{ outputs.promotion.prNumber != "" }}`}}
        retry:
          errorThreshold: 3
        config:
          repoURL: "{{`${{ vars.gitRepo }}`}}"
          prNumber: {{`${{ outputs.promotion.prNumber }}`}}
{{- end }}
{{- end }}
{{- end }}