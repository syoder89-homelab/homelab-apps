apiVersion: kargo.akuity.io/v1alpha1
kind: PromotionTask
metadata:
  name: prepare-workdir
  namespace: homelab-apps
spec:
  # Task-wide input variables
  vars:
  - name: gitRepo
  - name: sourceBranch
    value: main
  - name: targetBranch
    value: env/${{ ctx.stage }}
  - name: path_src
    value: ./src
  - name: path_out
    value: ./out
  - name: path_out
    value: ${{ path_out }}/out
  - name: clearPath
    value: "true"
  # Sequence of promotion steps
  steps:
    - uses: git-clone
      config:
        repoURL: ${{ vars.gitRepo }}
        checkout:
        - branch: ${{ vars.sourceBranch }}
          path: ${{ vars.path_src }}
        - branch: ${{ vars.targetBranch }}
          create: true
          path: ${{ vars.path_out }}
    - uses: git-clear
      if: ${{ vars.clearPath == "true" }}
      config:
        path: ${{ vars.path_out }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: PromotionTask
metadata:
  name: push-manifests
  namespace: homelab-apps
spec:
  # Task-wide input variables
  vars:
  - name: gitRepo
  - name: sourceBranch
    value: main
  - name: targetBranch
    value: env/${{ ctx.stage }}
  - name: path_src
    value: ./src
  - name: path_out
    value: ./out
  - name: asPR
    value: "false"
  - name: waitForPR
    value: "true"
  # Sequence of promotion steps
  steps:
    - uses: git-commit
      as: commit
      config:
        path: ${{ vars.path_out }}
        message: "Update Kargo Applications to ${{ ctx.stage }} [skip ci]"
    - uses: git-push
      if: ${{ vars.asPR != "true" && status("commit") == 'Succeeded' }}
      config:
        path: ${{ vars.path_out }}
        targetBranch: ${{ vars.targetBranch }}
    - uses: git-push
      as: push
      if: ${{ vars.asPR == "true" && status("commit") == 'Succeeded' }}
      config:
        path: ${{ vars.path_out }}
        generateTargetBranch: true
    - uses: git-open-pr
      as: open-pr
      if: ${{ vars.asPR == "true" && status("commit") == 'Succeeded' }}
      config:
        repoURL: ${{ vars.gitRepo }}
        createTargetBranch: true
        sourceBranch: ${{ task.outputs['push'].branch }}
        targetBranch: ${{ vars.targetBranch }}
    - uses: git-wait-for-pr
      as: wait-for-pr
      if: ${{ vars.asPR == "true" && vars.waitForPR == "true" && status("commit") == 'Succeeded' }}
      config:
        repoURL: ${{ vars.gitRepo }}
        prNumber: ${{ task.outputs['open-pr'].pr.id }}
    - uses: compose-output
      as: output
      config:
        commit: "${{ status('commit') == 'Succeeded' && vars.asPR == 'true' && vars.waitForPR == 'true' ? task.outputs['wait-for-pr'].commit : task.outputs['commit'].commit }}"
        branch: ${{ vars.targetBranch }}
        prNumber: "${{ status('commit') == 'Succeeded' && vars.asPR == 'true' ? task.outputs['open-pr'].pr.id : ''}}"
---
# verify-deployment: Optional health check for deployed applications.
# Makes an HTTP GET request to a health endpoint and verifies the response.
# Use this between argocd-update and close-pr for additional verification
# beyond ArgoCD's sync+health check.
apiVersion: kargo.akuity.io/v1alpha1
kind: PromotionTask
metadata:
  name: verify-deployment
  namespace: homelab-apps
spec:
  vars:
  - name: healthURL
  - name: expectedStatus
    value: "200"
  - name: timeout
    value: "5m"
  - name: retries
    value: "10"
  steps:
    - uses: http
      as: health-check
      retry:
        timeout: ${{ vars.timeout }}
        errorThreshold: ${{ vars.retries }}
      config:
        method: GET
        url: ${{ vars.healthURL }}
        successExpression: "response.status == ${{ vars.expectedStatus }}"
    - uses: compose-output
      as: output
      config:
        healthy: "true"